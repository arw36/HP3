---
title: 'Supplementary Information: GAM Models'
output:
  html_document:
    toc: TRUE
    code_download: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
library(mgcv)
library(dplyr)
library(stringi)
library(parallel)
library(purrr)
library(ggplot2)
library(viridis)
library(knitr)
library(stargazer)
library(svglite)
source('R/model_reduction.R')
source("R/fit_gam.R")
set.seed(0)---
title: 'Supplementary Information: GAM Models'
output:
  html_document:
    toc: TRUE
    code_download: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
library(mgcv)
library(dplyr)
library(stringi)
library(parallel)
library(purrr)
library(ggplot2)
library(viridis)
library(knitr)
library(stargazer)
library(svglite)
source('R/model_reduction.R')
source("R/fit_gam.R")
set.seed(0)
opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r preprocess-data, cache=TRUE}
source("preprocess_data.R")
```

# Zoonoses GAM - All Associations

```{r fit-all-zoo, cache=TRUE}
data_set = hosts %>% # Do Stict IsZoonotic, 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

outcome_variable = "NSharedWithHoSa"

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  mass = "s(hMassGramsPVR, bs = 'tp', k=7)",
  interaction = c(
          "s(HabAreaCropLn, bs = 'tp', k=7)   + s(HabAreaCropChgLn, bs = 'tp', k=7)",
          "s(HabAreaGrassLn, bs = 'tp', k=7)  + s(HabAreaGrassChgLn, bs = 'tp', k=7)",
          "s(HabAreaUrbanLn, bs = 'tp', k=7)  + s(HabAreaUrbanChgLn, bs = 'tp', k=7)",
          "s(HabInhabitedLn, bs = 'tp', k=7)  + s(HabInhabitedChgLn, bs = 'tp', k=7)",
          "s(TotHumPopLn, bs = 'tp', k=7) + s(TotHumPopChgLn, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)",
          "s(HumPopDensLn, bs = 'tp', k=7) + s(HumPopDensLnChg, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)"),
  interaction2 = "s(hHuntedIUCN, bs='re')",
  interaction3 = "s(hArtfclHbttUsrIUCN, bs='re')",
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k=7)", "s(PdHoSaSTPD, bs = 'tp', k=7)"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k=7)", "s(hDiseaseZACitesLn, bs = 'tp', k=7)"),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

all_zoonoses = fit_all_gams(data_set,
                            outcome_variable,
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-table, cache=FALSE}
all_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-plot, fig.width=10, fig.height=12, cache=FALSE}
plot(all_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-summary, cache=FALSE}
summary(all_zoonoses$model[[1]])
```



# Zoonoses GAM - Strict Associations

```{r fit-all-zoo-strict, cache=TRUE}
all_zoonoses_strict = fit_all_gams(data_set,
                            outcome_variable = "NSharedWithHoSa_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-strict-table, cache=FALSE}
all_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-strict-summary, cache=FALSE}
summary(all_zoonoses_strict$model[[1]])
```



# All Viruses GAM - All Associations

```{r fit-all-vir, cache=TRUE}
#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
#dummys = dummys[, colSums(dummys) > 1]
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  s1 = "s(LnAreaHost, bs='cs', k = 7)",
  s2 = "s(hMassGramsPVR, bs='cs', k = 7)",
  s3 = c(
    "s(S100, bs='cs', k = 7)",
    "s(S80, bs='cs', k = 7)",
    "s(S50, bs='cs', k = 7)",
    "s(S40, bs='cs', k = 7)",
    "s(S20, bs='cs', k = 7)",
    "s(S, bs='cs', k = 7)"
  ),
   bias = c("s(hAllZACitesLn, bs='cs',k = 7)", "s(hDiseaseZACitesLn, bs='cs', k=7)"),
  stringsAsFactors = FALSE)

terms = c(dummy_terms, terms)

all_viruses = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-table, cache=FALSE}
all_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-vir-summary, cache=FALSE}
summary(all_viruses$model[[1]])
```



# All Viruses GAM - Strict Associations

```{r all-vir-strict-fit, cache=TRUE}
all_viruses_strict = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-strict-table, cache=FALSE}
all_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-vir-strict-summary, cache=FALSE}
summary(all_viruses_strict$model[[1]])
```



# Viral Traits GAM - All Associations

```{r vtraits-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*(?<!stringent)$")]

data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

#data_set = data_set %>% filter(NumHosts > 1)

terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic",
                       binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-table, cache=FALSE}
vtraits %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-summary, cache=FALSE}
summary(vtraits$model[[1]])
```



# Viral Traits GAM - Strict Associations


```{r vtraits-strict-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*stringent$")]

data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

#data_set = data_set %>% filter(NumHosts > 1)

terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits_strict = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic.stringent",
                       binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-strict-table, cache=FALSE}
vtraits_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-strict-summary, cache=FALSE}
summary(vtraits_strict$model[[1]])
```



# Zoonoses in Domestic Animals GAM - All Associations

```{r dom-fit, cache=TRUE}
domestics = read_excel('data/HP3_domestic-categories.xlsx') %>% 
  select(hHostNameFinal, domestic_category)
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "domestic")
data_set = left_join(data_set, domestics, by = "hHostNameFinal") %>% 
  mutate(hHostNameFinal = as.factor(hHostNameFinal)) %>% 
  mutate(domestic_category = ifelse(is.na(domestic_category), "Other", domestic_category)) %>% 
  droplevels()

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k = 7)", ""), #, "s(PdHoSaSTPD, bs = 're')"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_zoonoses = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-table, cache=FALSE}
domestic_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-summary, cache=FALSE}
summary(domestic_zoonoses$model[[1]])
```




# Zoonoses in Domestic Animals GAM - Strict Associations

```{r dom-strict-fit, cache=TRUE}
domestic_zoonoses_strict = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa_strict",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-strict-table, cache=FALSE}
domestic_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-strict-summary, cache=FALSE}
summary(domestic_zoonoses_strict$model[[1]])
```

# All Viruses in Domestic Animals GAM - All Associations

```{r dom-vir-fit, cache=TRUE}
#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_viruses = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-table, cache=FALSE}
domestic_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-summary, cache=FALSE}
summary(domestic_viruses$model[[1]])
```



# All Viruses in Domestic Animals GAM - Stringent Associations

```{r dom-vir-strict-fit, cache=TRUE}
domestic_viruses_strict = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost_strict",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-strict-table, cache=FALSE}
domestic_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-strict-summary, cache=FALSE}
summary(domestic_viruses_strict$model[[1]])
```

<!-- # Publication plots -->

```{r}
#svglite(file="rplot.svg", width = convertr::convert(113, "mm", "in"), convertr::convert(180, "mm", "in"), pointsize=7)
vir_plotdata = viruses %>% 
  filter(!is.na(vFamily), vFamily != "Unassigned") %>% 
  mutate(st_dist_noHoSa_max2 = ifelse(IsHoSa & !IsZoonotic, NA, st_dist_noHoSa_max)) %>% 
  group_by(vFamily) %>%
  mutate(prop_fam_zoonotic = sum(IsZoonotic) / n(),
         arr = max(st_dist_noHoSa_max2, na.rm=TRUE),
         n_in_fam = n()) %>% 
  group_by() %>% 
  mutate(vHostType = ifelse(IsHoSa & IsZoonotic, "Zoonotic", ifelse(IsHoSa, "Human Only", "Non-Human Only"))) %>% 
  mutate(st_dist_noHoSa_max = ifelse(is.na(st_dist_noHoSa_max), 0, st_dist_noHoSa_max)) %>% 
  arrange(prop_fam_zoonotic) %>% 
  mutate(vFamily = factor(vFamily, vFamily)) %>% 
  droplevels() %>%
  mutate(jitter_fams= as.numeric(vFamily) + (rnorm(n(), mean=0, sd=0.075))*as.numeric(n_in_fam != 1))

famnames = vir_plotdata %>% 
  group_by(vFamily) %>% 
  summarize(Family = vFamily[1],
            labloc = max(st_dist_noHoSa_max, na.rm=TRUE) + 10)

n_families = length(levels(vir_plotdata$vFamily))
jitter_vals = rnorm(nrow(vir_plotdata), mean=0, sd=0.1)

legendpts = data_frame(fill=c(viridis(5)[5], viridis(5)[4], "#1F7DDC"), x = 3:5 + 0.4, y = rep(240,3), vFamily = 1,
                       label = c("Human", "Non-human", "Zoonotic"))

vir_fam_plot = ggplot(vir_plotdata, aes(x=as.numeric(vFamily) + jitter_vals, y=st_dist_noHoSa_max, group=vFamily)) +
  geom_boxplot(mapping=aes(fill=prop_fam_zoonotic, x=as.numeric(vFamily), y=st_dist_noHoSa_max2), outlier.shape=NA, width=0.7, size=0.3) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill="#1F7DDC", col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Non-Human Only")) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill=viridis(5)[5], col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Zoonotic")) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill=viridis(5)[4], col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Human Only")) +
  geom_point(mapping=aes(x=x,y=y), data = legendpts, shape=21, size = 1, stroke=0.3, fill = c(viridis(5)[4], "#1F7DDC", viridis(5)[5])) +
  geom_text(mapping=aes(x=x,y=y + 10, label=label), data = legendpts, size=1.6, hjust =0, family="Helvetica") +
             
  scale_fill_viridis(option="inferno", begin=.9, end=0.3, breaks=c(0.03,0.97), expand=c(0,0), name="Proportion Family Zoonotic",
                     labels = c("0", "1"),
                     guide = guide_colorbar(ticks=FALSE, title.position = "top", direction = "horizontal",
                                            label.position = "bottom",  label.vjust = -4.5,
                                            barheight=unit(3, "mm"), barwidth = unit(25, "mm"), raster=TRUE)) +
  scale_x_continuous(breaks=1:n_families, labels = levels(vir_plotdata$vFamily),
                     limits=c(1, n_families), expand=c(0,0.5), oob=scales::rescale_none, name="") +
  scale_y_continuous(breaks=seq(0,300,by=100), expand=c(0,0), limits=c(-5, 350),
                     name ="max PHB (Myr)", oob=scales::rescale_none) + 
  theme_bw() +
  theme(text = element_text(family="Helvetica", size=7), panel.grid=element_blank(),
        legend.position=c(0.6, 0.1), 
        legend.title.align = 0.5,
        legend.text = element_text(color="white"),
        legend.title = element_text(size = 4.5),
        legend.background = element_blank(),
        panel.border=element_blank(), panel.background=element_blank(),
        axis.ticks.y=element_blank(), axis.ticks.x = element_line(size=0.3),
        axis.title.x=element_text(size=7, hjust=0.5, lineheight = 1.2), # margin=margin(t=8), debug=FALSE),
        axis.text.y = element_text(hjust=1, debug=FALSE)) +
  coord_flip()

grobs <- ggplotGrob(vir_fam_plot)$grobs
legend <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]
vir_fam_plot = cowplot::ggdraw(vir_fam_plot + theme(legend.position = "none")) + cowplot::draw_grob(legend, x=0.2, y=0.02)
source('plot_best_gam_vir_traits.R')
gamplots = cowplot::plot_grid(plotlist = c(smooth_plots, list(bin_plot)), nrow=2, labels=c("b", "c", "d", "e"), label_size=7)
allplots = cowplot::plot_grid(vir_fam_plot, gamplots, nrow=1, rel_widths=c(1.3, 2), labels=c("a", ""), label_size=7)
svglite(file="Figure02-viral-traits.svg", width = convertr::convert(183, "mm", "in"), convertr::convert(117, "mm", "in"), pointsize=7)
allplots# + cowplot::draw_grob(legend, x=0.1, y=0.1)
dev.off()
```

```{r}
df <- reshape2::melt(outer(1:4, 1:4), varnames = c("X1", "X2"))

svglite(file="Figure02-viral-traits.svg", width = convertr::convert(183, "mm", "in"), convertr::convert(117, "mm", "in"), pointsize=7)
p1 <- ggplot(df, aes(X1, X2)) + geom_tile(aes(fill = value))
p2 <- p1 + geom_point(aes(size = value))

# Basic form
p1 + scale_fill_continuous(guide = "colorbar")
dev.off9
```


opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

```{r preprocess-data, cache=TRUE}
source("preprocess_data.R")
```

# Zoonoses GAM - All Associations

```{r fit-all-zoo, cache=TRUE}
data_set = hosts %>% # Do Stict IsZoonotic, 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

outcome_variable = "NSharedWithHoSa"

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  mass = "s(hMassGramsPVR, bs = 'tp', k=7)",
  interaction = c(
          "s(HabAreaCropLn, bs = 'tp', k=7)   + s(HabAreaCropChgLn, bs = 'tp', k=7)",
          "s(HabAreaGrassLn, bs = 'tp', k=7)  + s(HabAreaGrassChgLn, bs = 'tp', k=7)",
          "s(HabAreaUrbanLn, bs = 'tp', k=7)  + s(HabAreaUrbanChgLn, bs = 'tp', k=7)",
          "s(HabInhabitedLn, bs = 'tp', k=7)  + s(HabInhabitedChgLn, bs = 'tp', k=7)",
          "s(TotHumPopLn, bs = 'tp', k=7) + s(TotHumPopChgLn, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)",
          "s(HumPopDensLn, bs = 'tp', k=7) + s(HumPopDensLnChg, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)"),
  interaction2 = "s(hHuntedIUCN, bs='re')",
  interaction3 = "s(hArtfclHbttUsrIUCN, bs='re')",
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k=7)", "s(PdHoSaSTPD, bs = 'tp', k=7)"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k=7)", "s(hDiseaseZACitesLn, bs = 'tp', k=7)"),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

all_zoonoses = fit_all_gams(data_set,
                            outcome_variable,
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-table, cache=FALSE}
all_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-plot, fig.width=10, fig.height=12, cache=FALSE}
plot(all_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-summary, cache=FALSE}
summary(all_zoonoses$model[[1]])
```



# Zoonoses GAM - Strict Associations

```{r fit-all-zoo-strict, cache=TRUE}
all_zoonoses_strict = fit_all_gams(data_set,
                            outcome_variable = "NSharedWithHoSa_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-strict-table, cache=FALSE}
all_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-strict-summary, cache=FALSE}
summary(all_zoonoses_strict$model[[1]])
```



# All Viruses GAM - All Associations

```{r fit-all-vir, cache=TRUE}
#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
#dummys = dummys[, colSums(dummys) > 1]
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  s1 = "s(LnAreaHost, bs='cs', k = 7)",
  s2 = "s(hMassGramsPVR, bs='cs', k = 7)",
  s3 = c(
    "s(S100, bs='cs', k = 7)",
    "s(S80, bs='cs', k = 7)",
    "s(S50, bs='cs', k = 7)",
    "s(S40, bs='cs', k = 7)",
    "s(S20, bs='cs', k = 7)",
    "s(S, bs='cs', k = 7)"
  ),
   bias = c("s(hAllZACitesLn, bs='cs',k = 7)", "s(hDiseaseZACitesLn, bs='cs', k=7)"),
  stringsAsFactors = FALSE)

terms = c(dummy_terms, terms)

all_viruses = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-table, cache=FALSE}
all_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-vir-summary, cache=FALSE}
summary(all_viruses$model[[1]])
```



# All Viruses GAM - Strict Associations

```{r all-vir-strict-fit, cache=TRUE}
all_viruses_strict = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-strict-table, cache=FALSE}
all_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-vir-strict-summary, cache=FALSE}
summary(all_viruses_strict$model[[1]])
```



# Viral Traits GAM - All Associations

```{r vtraits-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*(?<!stringent)$")]

data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

#data_set = data_set %>% filter(NumHosts > 1)

terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic",
                       binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-table, cache=FALSE}
vtraits %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-summary, cache=FALSE}
summary(vtraits$model[[1]])
```



# Viral Traits GAM - Strict Associations


```{r vtraits-strict-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*stringent$")]

data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

#data_set = data_set %>% filter(NumHosts > 1)

terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits_strict = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic.stringent",
                       binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-strict-table, cache=FALSE}
vtraits_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-strict-summary, cache=FALSE}
summary(vtraits_strict$model[[1]])
```



# Zoonoses in Domestic Animals GAM - All Associations

```{r dom-fit, cache=TRUE}
domestics = read_excel('data/HP3_domestic-categories.xlsx') %>% 
  select(hHostNameFinal, domestic_category)
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "domestic")
data_set = left_join(data_set, domestics, by = "hHostNameFinal") %>% 
  mutate(hHostNameFinal = as.factor(hHostNameFinal)) %>% 
  mutate(domestic_category = ifelse(is.na(domestic_category), "Other", domestic_category)) %>% 
  droplevels()

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k = 7)", ""), #, "s(PdHoSaSTPD, bs = 're')"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_zoonoses = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-table, cache=FALSE}
domestic_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-summary, cache=FALSE}
summary(domestic_zoonoses$model[[1]])
```




# Zoonoses in Domestic Animals GAM - Strict Associations

```{r dom-strict-fit, cache=TRUE}
domestic_zoonoses_strict = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa_strict",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-strict-table, cache=FALSE}
domestic_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-strict-summary, cache=FALSE}
summary(domestic_zoonoses_strict$model[[1]])
```

# All Viruses in Domestic Animals GAM - All Associations

```{r dom-vir-fit, cache=TRUE}
#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_viruses = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-table, cache=FALSE}
domestic_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-summary, cache=FALSE}
summary(domestic_viruses$model[[1]])
```



# All Viruses in Domestic Animals GAM - Stringent Associations

```{r dom-vir-strict-fit, cache=TRUE}
domestic_viruses_strict = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost_strict",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-strict-table, cache=FALSE}
domestic_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
  mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-strict-summary, cache=FALSE}
summary(domestic_viruses_strict$model[[1]])
```

<!-- # Publication plots -->

```{r}
#svglite(file="rplot.svg", width = convertr::convert(113, "mm", "in"), convertr::convert(180, "mm", "in"), pointsize=7)
vir_plotdata = viruses %>% 
  filter(!is.na(vFamily), vFamily != "Unassigned") %>% 
  mutate(st_dist_noHoSa_max2 = ifelse(IsHoSa & !IsZoonotic, NA, st_dist_noHoSa_max)) %>% 
  group_by(vFamily) %>%
  mutate(prop_fam_zoonotic = sum(IsZoonotic) / n(),
         arr = max(st_dist_noHoSa_max2, na.rm=TRUE),
         n_in_fam = n()) %>% 
  group_by() %>% 
  mutate(vHostType = ifelse(IsHoSa & IsZoonotic, "Zoonotic", ifelse(IsHoSa, "Human Only", "Non-Human Only"))) %>% 
  mutate(st_dist_noHoSa_max = ifelse(is.na(st_dist_noHoSa_max), 0, st_dist_noHoSa_max)) %>% 
  arrange(prop_fam_zoonotic) %>% 
  mutate(vFamily = factor(vFamily, vFamily)) %>% 
  droplevels() %>%
  mutate(jitter_fams= as.numeric(vFamily) + (rnorm(n(), mean=0, sd=0.075))*as.numeric(n_in_fam != 1))

famnames = vir_plotdata %>% 
  group_by(vFamily) %>% 
  summarize(Family = vFamily[1],
            labloc = max(st_dist_noHoSa_max, na.rm=TRUE) + 10)

n_families = length(levels(vir_plotdata$vFamily))
jitter_vals = rnorm(nrow(vir_plotdata), mean=0, sd=0.1)

legendpts = data_frame(fill=c(viridis(5)[4], viridis(5)[5], "#1F7DDC"), x = 6:8, y = rep(0,3), vFamily = 1)

vir_fam_plot = ggplot(vir_plotdata, aes(x=as.numeric(vFamily) + jitter_vals, y=st_dist_noHoSa_max, group=vFamily)) +
  geom_boxplot(mapping=aes(fill=prop_fam_zoonotic, x=as.numeric(vFamily), y=st_dist_noHoSa_max2), outlier.shape=NA, width=0.7, size=0.3) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill="#1F7DDC", col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Non-Human Only")) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill=viridis(5)[5], col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Zoonotic")) +
  geom_point(mapping=aes(col=vHostType, x = jitter_fams), shape=21, size = 1, fill=viridis(5)[4], col="black", stroke=0.3,
             data = filter(vir_plotdata, vHostType == "Human Only")) +
  geom_point(mapping=aes(x=x,y=y), data = legendpts) +
             
  scale_fill_viridis(option="inferno", begin=.9, end=0.3, breaks=c(0.03,0.97), expand=c(0,0), name="Proportion Family Zoonotic",
                     labels = c("0", "1"),
                     guide = guide_colorbar(ticks=FALSE, title.position = "top", direction = "horizontal",
                                            label.position = "bottom",  label.vjust = -4.5,
                                            barheight=unit(3, "mm"), barwidth = unit(25, "mm"), raster=TRUE)) +
  scale_x_continuous(breaks=1:n_families, labels = levels(vir_plotdata$vFamily),
                     limits=c(1, n_families), expand=c(0,0.5), oob=scales::rescale_none, name="") +
  scale_y_continuous(breaks=seq(0,250,by=50), expand=c(0,0), limits=c(-5, 250),
                     name ="max PHB (Myr)") + 
  theme_bw() +
  theme(text = element_text(family="Helvetica", size=7), panel.grid=element_blank(),
        legend.position=c(0.6, 0.1), 
        legend.title.align = 0.5,
        legend.text = element_text(color="white"),
        legend.title = element_text(size = 5),
        legend.background = element_blank(),
        panel.border=element_blank(), panel.background=element_blank(),
        axis.ticks.y=element_blank(), axis.ticks.x = element_line(size=0.3),
        axis.title.x=element_text(size=7, hjust=0.5, lineheight = 1.2), # margin=margin(t=8), debug=FALSE),
        axis.text.y = element_text(hjust=1, debug=FALSE)) +
  coord_flip()

grobs <- ggplotGrob(vir_fam_plot)$grobs
legend <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]
vir_fam_plot = cowplot::ggdraw(vir_fam_plot + theme(legend.position = "none")) + cowplot::draw_grob(legend, x=0.2, y=0.02)
source('plot_best_gam_vir_traits.R')
gamplots = cowplot::plot_grid(plotlist = c(smooth_plots, list(bin_plot)), nrow=2, labels=c("b", "c", "d", "e"), label_size=7)
allplots = cowplot::plot_grid(vir_fam_plot, gamplots, nrow=1, rel_widths=c(1.3, 2), labels=c("a", ""), label_size=7)
svglite(file="Figure02-viral-traits.svg", width = convertr::convert(183, "mm", "in"), convertr::convert(117, "mm", "in"), pointsize=7)
allplots# + cowplot::draw_grob(legend, x=0.1, y=0.1)
dev.off()
```
