---
title: "HP3: Zoogeographical Cross-Validation"
output:
  html_document:
    toc: TRUE
    code_download: TRUE
    keep_md: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
library(mgcv)
library(raster)
library(dplyr)
library(stringi)
library(parallel)
library(purrr)
library(ggplot2)
library(viridis)
library(knitr)
library(svglite)
library(sp)
library(readr)
library(rgdal)
library(stringr)
library(classInt)
library(maptools)
library(tibble)
library(mgcv)
library(tidyr)
library(DT)
P <- rprojroot::find_rstudio_root_file
source(P("R/model_reduction.R"))
source(P("R/fit_gam.R"))
source(P("R/relative_contributions.R"))
source(P("R/cross_validation.R"))
source(P("R/cv_gam_by.R"))
set.seed(0)
opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, autodep=TRUE)
```

```{r db-loading, cache = TRUE}
db <- readRDS(P("model_fitting/postprocessed_database.rds"))
hosts <- db[["hosts"]]
host_names <- read_csv(P("data/hosts.csv")) %>%
  select(hHostNameFinal, Common_names_Eng)

```
# Zoogeographic Cross-Validation

In addition to randomly-selected k-fold cross-validation, we evaluated the robustness of our models via non-random geographic cross-validation: we systematically removed all observations from a zoogeographical region, re-fit the model using all observations from outside the region, then performed a non-parametric permutation test comparing the predicted values to the observed values for that region.

In order to meaningfully organize geographic areas, we utilized mammalian zoogeographic regions from [*Holt et al (2013)*](http://dx.doi.org/10.1126/science.1228282) which are defined by distributions of and phylogenetic relationships between species. Using QGIS, a mammal-specific zoogeographical shapefile provided by [Holt's group](http://macroecology.ku.dk/resources/wallace) at the University of Copenhagen was intersected (using QGIS Vector > Geoprocessing Tools > Intersect) with a shapefile of IUCN's host ranges. Areas of these intersections were then calculated using an equal-area projection, and each host was assigned to only the region which contained the greatest proportion of its range. Results of the non-parametric permutation test are shown below; non-significant results indicate that model predictions are unbiased.

```{r map-setup, cache = TRUE, message=FALSE}
zregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)
#Intersected with IUCN habitat shapefile in QGIS
zoog_mammals <- shapefile(P("maps/host_zg_area.shp"), verbose = FALSE)
zoog_mammals_data <- as_tibble(zoog_mammals@data)

#Paring down the dataset
zgm_reduced <- zoog_mammals_data %>%
  select(BINOMIAL, mam_upgma_, garea2)
#Assigning only largest areas
zgm <- zgm_reduced %>%
  group_by(BINOMIAL) %>%
  mutate(area = max(garea2)) %>%
  filter(garea2 == area) %>%
  arrange(BINOMIAL)
zgm <- unique(zgm)

region_names <- readRDS(P("data/region_names.rds"))

sp_rng_lookup <- left_join(zgm, region_names, by = c("mam_upgma_" = "fold")) %>%
  select(name, BINOMIAL) %>%
  group_by(name) %>%
  nest()



```

# Zoonoses GAM - All Associations

```{r all-zoo, cache=TRUE}
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)

###### ALL ZOONOSES
allz_gam = readRDS(P("model_fitting/all_zoonoses_model.rds"))

joined_dat <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
joined_dat <- filter_down(allz_gam, joined_dat, "mam_upgma_")

results<-cv_gam_by_zg(allz_gam, joined_dat,unique(joined_dat$mam_upgma_))

###### ADDING 


region_dat <- joined_dat %>%
  mutate(zg_region = as.factor(mam_upgma_))

region_gam <- gam(NSharedWithHoSa ~ s(hAllZACitesLn, bs = "tp", k = 7) + s(hHuntedIUCN, bs = "re") + s(hOrderCETARTIODACTYLA, bs = "re") + 
                       s(hOrderCHIROPTERA, bs = "re") + s(hOrderDIPROTODONTIA, bs = "re") + 
                       s(hOrderPERAMELEMORPHIA, bs = "re") + s(hOrderPERISSODACTYLA, bs = "re") + s(zg_region, bs = "re") +
                       s(hOrderSCANDENTIA, bs = "re") + s(PdHoSa.cbCst, bs = "tp", k = 7) + 
                       s(UrbRurPopRatioLn, bs = "tp", k = 7) + offset(LnTotNumVirus), poisson, region_dat, select=TRUE)

rep_gam <- gam(NSharedWithHoSa ~ s(hAllZACitesLn, bs = "tp", k = 7) + s(hHuntedIUCN, bs = "re") + s(hOrderCETARTIODACTYLA, bs = "re") + 
                       s(hOrderCHIROPTERA, bs = "re") + s(hOrderDIPROTODONTIA, bs = "re") + 
                       s(hOrderPERAMELEMORPHIA, bs = "re") + s(hOrderPERISSODACTYLA, bs = "re") + 
                       s(hOrderSCANDENTIA, bs = "re") + s(PdHoSa.cbCst, bs = "tp", k = 7) + 
                       s(UrbRurPopRatioLn, bs = "tp", k = 7) + offset(LnTotNumVirus), poisson, region_dat, select=TRUE)

gam.vcomp(region_gam)

##############

zregions@data <- left_join(zregions@data, results, by=c("mam_upgma_"="fold"))

data("wrld_simpl")
small_world <- subset(wrld_simpl, wrld_simpl@data$NAME != "Antarctica")
plot(small_world)

zregions %>%
  subset(zregions@data$p_value < 0.05 & zregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

zregions %>%
  subset(zregions@data$p_value < 0.05 & zregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

zregions %>%
  subset(zregions@data$p_value >= 0.05 & zregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

zregions %>%
  subset(zregions@data$p_value >= 0.05 & zregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("All Zoonoses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r all-zoo-tables, results = "asis"}
results<-left_join(results, region_names, by = "fold")

results %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

results %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

## Biased Region Details -- Zoonoses GAM: 

### Southeastern South America:
```{r se_sa, cache = TRUE}

create_pred_df <- function(model, data, region){
  r <- cv_get_zg_preds(model, data, region) %>%
    left_join(host_names, by = c("name" = "hHostNameFinal"))
  display_df <- r %>%
    mutate(species = str_replace(name, "_", " ")) %>%
    mutate(absdiff = abs(diff)) %>%
    arrange(desc(absdiff)) %>%
    mutate(predicted = round(predicted,3), observed = round(observed,3), diff = round(diff,3)) %>%
    select(`Common Name` = Common_names_Eng, Species = species, `Predicted Zoonoses` = predicted, `Observed Zoonoses` = observed, `Difference Between Observed and Predicted` = diff)
  return(display_df)
}

se_sa <- create_pred_df(allz_gam, joined_dat, 10)
se_sa[13,1] <- "Paraguayan rice rat"
datatable(se_sa)
```

### Central African Band:
```{r cab, cache = TRUE}

cab <- create_pred_df(allz_gam, joined_dat, 14)
cab[1,1] <- "Kemp's Gerbil"
datatable(cab)
```

### Northern Eurussia:
```{r noruss, cache = TRUE}

noruss <- create_pred_df(allz_gam, joined_dat, 25)

datatable(noruss)
```

### Southeastern China:
```{r se_china, cache = TRUE}

se_china <- create_pred_df(allz_gam, joined_dat, 27)
se_china[5,1] <- "Francois's Langur"
datatable(se_china)
```


# All Viruses GAM - All Associations

```{r all-viruses, cache = TRUE}
###### ALL VIRUSES
allv_gam = readRDS(P("model_fitting/all_viruses_model.rds"))
vregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)


temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(allv_gam, temp, "mam_upgma_")

vresults<-cv_gam_by_zg(allv_gam, temp,unique(temp$mam_upgma_))

vregions@data <- left_join(vregions@data, vresults, by=c("mam_upgma_"="fold"))

plot(small_world)

vregions %>%
  subset(vregions@data$p_value < 0.05 & vregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

vregions %>%
  subset(vregions@data$p_value < 0.05 & vregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

vregions %>%
  subset(vregions@data$p_value >= 0.05 & vregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

vregions %>%
  subset(vregions@data$p_value >= 0.05 & vregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("All Viruses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r all-virus-tables, results = "asis"}
vresults<-left_join(vresults, region_names, by = "fold")

vresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

vresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

## Biased Region Details -- All Viruses GAM: 

### Central African Band:
```{r cab2, cache = TRUE}
create_pred_df_v <- function(model, data, region){
  r <- cv_get_zg_preds(model, data, region) %>%
    left_join(host_names, by = c("name" = "hHostNameFinal"))
  display_df <- r %>%
    mutate(species = str_replace(name, "_", " ")) %>%
    mutate(absdiff = abs(diff)) %>%
    arrange(desc(absdiff)) %>%
    mutate(predicted = round(predicted,3), observed = round(observed,3), diff = round(diff,3)) %>%
    select(`Common Name` = Common_names_Eng, Species = species, `Predicted Viruses` = predicted, `Observed Viruses` = observed, `Difference Between Observed and Predicted` = diff)
  return(display_df)
}
cab2 <- create_pred_df_v(allv_gam, temp, 14)

datatable(cab2)
```

### Europe:
```{r eur, cache = TRUE}

eur <- create_pred_df_v(allv_gam, temp, 15)
eur[31,1] <- "Montane Water Vole"
datatable(eur)
```

### South Africa:
```{r safrica, cache = TRUE}

safrica <- create_pred_df_v(allv_gam, temp, 16)
safrica[23,1] <- "Black-backed Jackal"
datatable(safrica)
```

### Southeastern China:
```{r se_china2, cache = TRUE}

se_china2 <- create_pred_df_v(allv_gam, temp, 27)
se_china2[10,1] <- "Francois's Langur"
datatable(se_china2)
```

# Zoonoses GAM - Strict Associations

```{r strict-zoo, cache = TRUE}
model_list <- readRDS(P("model_fitting/top_models.rds"))
strictz_gam <- model_list$all_zoonoses_strict

szregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)

temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(strictz_gam, temp, "mam_upgma_")

region_dat <- temp %>%
  mutate(zg_region = as.factor(mam_upgma_))

########ASIDE
sz_rep_gam <- gam(NSharedWithHoSa_strict ~ s(hDiseaseZACitesLn, bs = "tp", k = 7) + 
    s(hMassGramsPVR, bs = "tp", k = 7) + s(hOrderCETARTIODACTYLA, 
    bs = "re") + s(hOrderDIPROTODONTIA, bs = "re") + s(hOrderLAGOMORPHA, 
    bs = "re") + s(hOrderPERISSODACTYLA, bs = "re") + s(hOrderPRIMATES, 
    bs = "re") + s(HumPopDensLnChg, bs = "tp", k = 7) + s(PdHoSa.cbCst, 
    bs = "tp", k = 7) + s(UrbRurPopRatioChg, bs = "tp", k = 7) + 
    offset(LnTotNumVirus), poisson, region_dat, select = TRUE)

sz_region_gam <- gam(NSharedWithHoSa_strict ~ s(hDiseaseZACitesLn, bs = "tp", k = 7) + 
    s(hMassGramsPVR, bs = "tp", k = 7) + s(hOrderCETARTIODACTYLA, bs = "re") + 
      s(hOrderDIPROTODONTIA, bs = "re") + s(hOrderLAGOMORPHA, bs = "re") + s(zg_region, bs = "re") +
      s(hOrderPERISSODACTYLA, bs = "re") + s(hOrderPRIMATES, bs = "re") + 
      s(HumPopDensLnChg, bs = "tp", k = 7) + s(PdHoSa.cbCst, bs = "tp", k = 7) + 
      s(UrbRurPopRatioChg, bs = "tp", k = 7) + offset(LnTotNumVirus), poisson, region_dat, select = TRUE)

order_cat <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
order_cat <- order_cat %>%
  mutate(zg_region = as.factor(mam_upgma_))



sz_order_region_gam <- gam(NSharedWithHoSa_strict ~ s(hDiseaseZACitesLn, bs = "tp", k = 7) + 
    s(hMassGramsPVR, bs = "tp", k = 7) +  s(zg_region, bs = "re") + s(hOrder, bs = "re") +
      s(HumPopDensLnChg, bs = "tp", k = 7) + s(PdHoSa.cbCst, bs = "tp", k = 7) + 
      s(UrbRurPopRatioChg, bs = "tp", k = 7) + offset(LnTotNumVirus), poisson, order_cat, select = TRUE)

sz_order_gam <- gam(NSharedWithHoSa_strict ~ s(hDiseaseZACitesLn, bs = "tp", k = 7) + 
    s(hMassGramsPVR, bs = "tp", k = 7) + s(hOrder, bs = "re") +
      s(HumPopDensLnChg, bs = "tp", k = 7) + s(PdHoSa.cbCst, bs = "tp", k = 7) + 
      s(UrbRurPopRatioChg, bs = "tp", k = 7) + offset(LnTotNumVirus), poisson, order_cat, select = TRUE)


#########

szresults<-cv_gam_by_zg(strictz_gam, temp,unique(temp$mam_upgma_))

szregions@data <- left_join(szregions@data, szresults, by=c("mam_upgma_"="fold"))

plot(small_world)

szregions %>%
  subset(szregions@data$p_value < 0.05 & szregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

szregions %>%
  subset(szregions@data$p_value < 0.05 & szregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

szregions %>%
  subset(szregions@data$p_value >= 0.05 & szregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

szregions %>%
  subset(szregions@data$p_value >= 0.05 & szregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("Strict Zoonoses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned 
species; blank areas were not assigned any hosts.  

```{r sz-tables, results = "asis"}
szresults<-left_join(szresults, region_names, by = "fold")

szresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)
```

```{r sz-tables2}
szresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

## Biased Region Details -- Strict Zoonoses GAM: 

### Northern America:
```{r na, cache = TRUE}
na <- create_pred_df(strictz_gam, temp, 1)

datatable(na)
```

### Southern Central America:
```{r sca, cache = TRUE}
sca <- create_pred_df(strictz_gam, temp, 5)

datatable(sca)
```

### Northern South America:
```{r nsa, cache = TRUE}
nsa <- create_pred_df(strictz_gam, temp, 9)
nsa[17,1] <- "Large-headed rice rat"
nsa[80,1] <- "Southern Long-nosed bat"
datatable(nsa)
```

### Southeastern South America:
```{r ssa, cache = TRUE}
ssa <- create_pred_df(strictz_gam, temp, 10)

datatable(ssa)
```

### West Central Africa:
```{r wca, cache = TRUE}
wca <- create_pred_df(strictz_gam, temp, 13)

datatable(wca)
```

### Central African Band:
```{r cab3, cache = TRUE}
cab3 <- create_pred_df(strictz_gam, temp, 14)
cab3[12,1] <- "Kemp's Gerbil"
datatable(cab3)
```

### Northern Eurussia:
```{r neurussia, cache = TRUE}
neurussia <- create_pred_df(strictz_gam, temp, 25)

datatable(neurussia)
```

### Southeast Asia:
```{r se_asia, cache = TRUE}
se_asia <- create_pred_df(strictz_gam, temp, 26)

datatable(se_asia)
```


# All Viruses GAM - Strict Associations

```{r strict-viruses, cache = TRUE}
strictv_gam <- model_list$all_viruses_strict

svregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)

temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(strictv_gam, temp, "mam_upgma_")

svresults<-cv_gam_by_zg(strictv_gam, temp,unique(temp$mam_upgma_))

svregions@data <- left_join(svregions@data, svresults, by=c("mam_upgma_"="fold"))

plot(small_world)

svregions %>%
  subset(svregions@data$p_value < 0.05 & svregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

svregions %>%
  subset(svregions@data$p_value < 0.05 & svregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

svregions %>%
  subset(svregions@data$p_value >= 0.05 & svregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

svregions %>%
  subset(svregions@data$p_value >= 0.05 & svregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("Strict Viruses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r strict-zoo-tables, results = "asis"}
svresults<-left_join(svresults, region_names, by = "fold")

svresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

svresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)
```

## Biased Region Details -- Strict Viruses:

### Northern America:
```{r na_sv, cache = TRUE}
na_sv <- create_pred_df_v(strictv_gam, temp, 1)

datatable(na_sv)
```

### Southern Central America:
```{r sca_sv, cache = TRUE}
sca_sv <- create_pred_df_v(strictv_gam, temp, 5)

datatable(sca_sv)
```

### West Central Africa:
```{r wca_sv, cache = TRUE}
wca_sv <- create_pred_df_v(strictv_gam, temp, 13)

datatable(wca_sv)
```

### Central African Band:
```{r cab_sv, cache = TRUE}
cab_sv <- create_pred_df_v(strictv_gam, temp, 14)
cab_sv[4,1] <- "Kemp's Gerbil"
datatable(cab_sv)
```

### Southeastern China:
```{r sec_sv, cache = TRUE}
sec_sv <- create_pred_df_v(strictv_gam, temp, 27)
sec_sv[13,1] <- "Francois's Langur"
datatable(sec_sv)
```


#Conclusions
	
The reviewer articulated concerns about our models' ability to make out-of-sample predictions, arguing that cross-validation based on random folds does not adequately address this issue. This analysis shows that our models (especially *Zoonoses*, *Viruses*, and *Strict Viruses*) are robust to a systematic cross-validation that creates folds based on geographical/phylogenetic region ~ a non-random method to approximate out-of-sample testing. For each of these three models, only 4-5 substantial (n > 10) folds show evidence of bias, while 10-11 substantial folds are well-predicted. For the *Strict Zoonoses* model the evidence is more equivocal, with 8 substantial regions that show evidence of bias and 7 substantial regions which are well-predicted. 

