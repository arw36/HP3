---
title: "HP3: Zoogeographical Cross-Validation"
output:
  html_document:
    toc: TRUE
    code_download: TRUE
    keep_md: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
library(mgcv)
library(raster)
library(dplyr)
library(stringi)
library(parallel)
library(purrr)
library(ggplot2)
library(viridis)
library(knitr)
library(svglite)
library(sp)
library(readr)
library(rgdal)
library(stringr)
library(classInt)
library(maptools)
library(tibble)
library(mgcv)
P <- rprojroot::find_rstudio_root_file
source(P("R/model_reduction.R"))
source(P("R/fit_gam.R"))
source(P("R/relative_contributions.R"))
source(P("R/cross_validation.R"))
source(P("R/cv_gam_by.R"))
set.seed(0)
opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, autodep=TRUE)
```

```{r model-loading, cache = TRUE}
source(P("model_fitting/preprocess_data.R"))
saveRDS(list(hosts=hosts, viruses=viruses, associations=associations), P("model_fitting/postprocessed_database.rds"))
```
# Zoogeographic Cross-Validation

In addition to randomly-selected k-fold cross-validation, we evaluated the robustness of our models via non-random geographic cross-validation: we systematically removed all observations from a zoogeographical region, re-fit the model using all observations from outside the region, then performed a non-parametric permutation test comparing the predicted values to the observed values for that region.

In order to meaningfully organize geographic areas, we utilized mammalian zoogeographic regions from [*Holt et al (2013)*](http://dx.doi.org/10.1126/science.1228282) which are defined by distributions of and phylogenetic relationships between species. Using QGIS, a mammal-specific zoogeographical shapefile provided by [Holt's group](http://macroecology.ku.dk/resources/wallace) at the University of Copenhagen was intersected (using QGIS Vector > Geoprocessing Tools > Intersect) with a shapefile of IUCN's host ranges. Areas of these intersections were then calculated using an equal-area projection, and each host was assigned to only the region which contained the greatest proportion of its range. Results of the non-parametric permutation test are shown below; non-significant results indicate that model predictions are unbiased.

```{r map-setup, cache = TRUE, message=FALSE}
zregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)
#Intersected with IUCN habitat shapefile in QGIS
zoog_mammals <- shapefile(P("maps/host_zg_area.shp"), verbose = FALSE)
zoog_mammals_data <- as_tibble(zoog_mammals@data)

#Paring down the dataset
zgm_reduced <- zoog_mammals_data %>%
  select(BINOMIAL, mam_upgma_, garea2)
#Assigning only largest areas
zgm <- zgm_reduced %>%
  group_by(BINOMIAL) %>%
  mutate(area = max(garea2)) %>%
  filter(garea2 == area) %>%
  arrange(BINOMIAL)
zgm <- unique(zgm)

region_names <- readRDS(P("data/region_names.rds"))
```

# Zoonoses GAM - All Associations

```{r all-zoo, cache=TRUE}
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)

###### ALL ZOONOSES
allz_gam = readRDS(P("model_fitting/all_zoonoses_model.rds"))

joined_dat <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
joined_dat <- filter_down(allz_gam, joined_dat, "mam_upgma_")

results<-cv_gam_by_zg(allz_gam, joined_dat,unique(joined_dat$mam_upgma_))

zregions@data <- left_join(zregions@data, results, by=c("mam_upgma_"="fold"))

data("wrld_simpl")
small_world <- subset(wrld_simpl, wrld_simpl@data$NAME != "Antarctica")
plot(small_world)

zregions %>%
  subset(zregions@data$p_value < 0.05 & zregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

zregions %>%
  subset(zregions@data$p_value < 0.05 & zregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

zregions %>%
  subset(zregions@data$p_value >= 0.05 & zregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

zregions %>%
  subset(zregions@data$p_value >= 0.05 & zregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("All Zoonoses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r all-zoo-tables, results = "asis"}
results<-left_join(results, region_names, by = "fold")

results %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

results %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

# All Viruses GAM - All Associations

```{r all-viruses, cache = TRUE}
###### ALL VIRUSES
allv_gam = readRDS(P("model_fitting/all_viruses_model.rds"))
vregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)


temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(allv_gam, temp, "mam_upgma_")

vresults<-cv_gam_by_zg(allv_gam, temp,unique(temp$mam_upgma_))

vregions@data <- left_join(vregions@data, vresults, by=c("mam_upgma_"="fold"))

plot(small_world)

vregions %>%
  subset(vregions@data$p_value < 0.05 & vregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

vregions %>%
  subset(vregions@data$p_value < 0.05 & vregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

vregions %>%
  subset(vregions@data$p_value >= 0.05 & vregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

vregions %>%
  subset(vregions@data$p_value >= 0.05 & vregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("All Viruses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r all-virus-tables, results = "asis"}
vresults<-left_join(vresults, region_names, by = "fold")

vresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

vresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

# Zoonoses GAM - Strict Associations

```{r strict-zoo, cache = TRUE}
model_list <- readRDS(P("model_fitting/top_models.rds"))
strictz_gam <- model_list$all_zoonoses_strict

szregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)

temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(strictz_gam, temp, "mam_upgma_")

szresults<-cv_gam_by_zg(strictz_gam, temp,unique(temp$mam_upgma_))

szregions@data <- left_join(szregions@data, szresults, by=c("mam_upgma_"="fold"))

plot(small_world)

szregions %>%
  subset(szregions@data$p_value < 0.05 & szregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

szregions %>%
  subset(szregions@data$p_value < 0.05 & szregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

szregions %>%
  subset(szregions@data$p_value >= 0.05 & szregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

szregions %>%
  subset(szregions@data$p_value >= 0.05 & szregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("Strict Zoonoses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned 
species; blank areas were not assigned any hosts.  

```{r sz-tables, results = "asis"}
szresults<-left_join(szresults, region_names, by = "fold")

szresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)
```

```{r sz-tables2}
szresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)

```

# All Viruses GAM - Strict Associations

```{r strict-viruses, cache = TRUE}
strictv_gam <- model_list$all_viruses_strict

svregions <- shapefile(P("maps/mam.shp"), verbose = FALSE)

temp <- left_join(data_set, zgm, by=c("hHostNameFinal"="BINOMIAL"))
temp <- filter_down(strictv_gam, temp, "mam_upgma_")

svresults<-cv_gam_by_zg(strictv_gam, temp,unique(temp$mam_upgma_))

svregions@data <- left_join(svregions@data, svresults, by=c("mam_upgma_"="fold"))

plot(small_world)

svregions %>%
  subset(svregions@data$p_value < 0.05 & svregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="red")

svregions %>%
  subset(svregions@data$p_value < 0.05 & svregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="pink")

svregions %>%
  subset(svregions@data$p_value >= 0.05 & svregions@data$n_validate > 10) %>%
  plot(.,add=TRUE, col="darkgreen")

svregions %>%
  subset(svregions@data$p_value >= 0.05 & svregions@data$n_validate < 10) %>%
  plot(.,add=TRUE, col="lightgreen")

title("Strict Viruses: 31 Regions")
```

Dark green indicates unbiased regions, while dark red indicates regions with evidence of biased predictions. Light green and light red represent the same distinction, but these regions contain very few (less than ten) assigned species; blank areas were not assigned any hosts. 

```{r strict-zoo-tables, results = "asis"}
svresults<-left_join(svresults, region_names, by = "fold")

svresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value < 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Biased Predictions Regions (n > 10)", digits = 4)

svresults %>% arrange(fold) %>%
  filter(n_validate > 10, p_value >= 0.05) %>%
  select(name, n_fit, n_validate, p_value, mean_diff) %>%
  rename(Region = name, `Observations Fit` = n_fit, `Observations Held Out` = n_validate, 
         `P-value` = p_value, `Mean Prediction Difference` = mean_diff) %>%
  kable(caption = "Unbiased Prediction Regions (n > 10)", digits = 4)
```

#Conclusions

Conclusions to follow. 
