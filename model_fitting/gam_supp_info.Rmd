---
title: 'Supplementary Information: GAM Models'
output:
  html_document:
    toc: TRUE
    code_download: TRUE
    keep_md: TRUE
---

```{r setup, include=FALSE, cache=FALSE}
library(mgcv)
library(dplyr)
library(stringi)
library(parallel)
library(purrr)
library(ggplot2)
library(viridis)
library(knitr)
library(svglite)
P <- rprojroot::find_rstudio_root_file
source(P("R/model_reduction.R"))
source(P("R/fit_gam.R"))
source(P("R/relative_contributions.R"))
source(P("R/cross_validation.R"))
set.seed(0)
opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, autodep=TRUE)
```

```{r preprocess-data, cache=TRUE}
source(P("model_fitting/preprocess_data.R"))
saveRDS(list(hosts=hosts, viruses=viruses, associations=associations), P("model_fitting/postprocessed_database.rds"))
```

# Zoonoses GAM - All Associations

```{r fit-all-zoo, cache=TRUE}
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

outcome_variable = "NSharedWithHoSa"

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  mass = "s(hMassGramsPVR, bs = 'tp', k=7)",
  interaction = c(
          "s(HabAreaCropLn, bs = 'tp', k=7)   + s(HabAreaCropChgLn, bs = 'tp', k=7)",
          "s(HabAreaGrassLn, bs = 'tp', k=7)  + s(HabAreaGrassChgLn, bs = 'tp', k=7)",
          "s(HabAreaUrbanLn, bs = 'tp', k=7)  + s(HabAreaUrbanChgLn, bs = 'tp', k=7)",
          "s(HabInhabitedLn, bs = 'tp', k=7)  + s(HabInhabitedChgLn, bs = 'tp', k=7)",
          "s(TotHumPopLn, bs = 'tp', k=7) + s(TotHumPopChgLn, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)",
          "s(HumPopDensLn, bs = 'tp', k=7) + s(HumPopDensLnChg, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)"),
  interaction2 = "s(hHuntedIUCN, bs='re')",
  interaction3 = "s(hArtfclHbttUsrIUCN, bs='re')",
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k=7)", "s(PdHoSaSTPD, bs = 'tp', k=7)"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k=7)", "s(hDiseaseZACitesLn, bs = 'tp', k=7)"),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

all_zoonoses = fit_all_gams(data_set,
                            outcome_variable,
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-table, cache=FALSE}
all_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-plot, fig.width=10, fig.height=12, cache=FALSE}
plot(all_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-summary, cache=FALSE}
summary(all_zoonoses$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r all-zoo-contrib, cache=FALSE}
get_relative_contribs(all_zoonoses$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r all-zoo-cv, cache=TRUE}
cv_gam(all_zoonoses$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# Zoonoses GAM - Strict Associations

```{r fit-all-zoo-strict, cache=TRUE}
model_family = poisson

all_zoonoses_strict = fit_all_gams(data_set,
                            outcome_variable = "NSharedWithHoSa_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-strict-table, cache=FALSE}
all_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-strict-summary, cache=FALSE}
summary(all_zoonoses_strict$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r all-zoo-strict-contrib, cache=FALSE}
get_relative_contribs(all_zoonoses_strict$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r all-zoo-strict-cv, cache=TRUE}
cv_gam(all_zoonoses_strict$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# Zoonoses GAM - All Associations without Reverse Zoonoses

```{r fit-all-zoo-norev, cache=TRUE}
data_set = hosts %>% # 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

outcome_variable = "NSharedWithHoSa_norev"

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

model_family = poisson


## Create data.frame of all possible models
terms = list(
  mass = "s(hMassGramsPVR, bs = 'tp', k=7)",
  interaction = c(
          "s(HabAreaCropLn, bs = 'tp', k=7)   + s(HabAreaCropChgLn, bs = 'tp', k=7)",
          "s(HabAreaGrassLn, bs = 'tp', k=7)  + s(HabAreaGrassChgLn, bs = 'tp', k=7)",
          "s(HabAreaUrbanLn, bs = 'tp', k=7)  + s(HabAreaUrbanChgLn, bs = 'tp', k=7)",
          "s(HabInhabitedLn, bs = 'tp', k=7)  + s(HabInhabitedChgLn, bs = 'tp', k=7)",
          "s(TotHumPopLn, bs = 'tp', k=7) + s(TotHumPopChgLn, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)",
          "s(HumPopDensLn, bs = 'tp', k=7) + s(HumPopDensLnChg, bs = 'tp', k=7) + s(UrbRurPopRatioLn, bs = 'tp', k=7) + s(UrbRurPopRatioChg, bs = 'tp', k=7)"),
  interaction2 = "s(hHuntedIUCN, bs='re')",
  interaction3 = "s(hArtfclHbttUsrIUCN, bs='re')",
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k=7)", "s(PdHoSaSTPD, bs = 'tp', k=7)"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k=7)", "s(hDiseaseZACitesLn, bs = 'tp', k=7)"),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

all_zoonoses_norev = fit_all_gams(data_set,
                            outcome_variable,
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-zoo-norev-table, cache=FALSE}
all_zoonoses_norev %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-zoo-norev-plot, fig.width=10, fig.height=12, cache=FALSE}
plot(all_zoonoses_norev$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-zoo-norev-summary, cache=FALSE}
summary(all_zoonoses_norev$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r all-zoo-norev-contrib, cache=FALSE}
get_relative_contribs(all_zoonoses_norev$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r all-zoo-norev-cv, cache=TRUE}
cv_gam(all_zoonoses_norev$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# All Viruses GAM - All Associations

```{r fit-all-vir, cache=TRUE}
data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "wild",
         !is.na(PdHoSa.cbCst_order))

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
#dummys = dummys[, colSums(dummys) > 1]
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

## Create data.frame of all possible models
terms = list(
  s1 = "s(LnAreaHost, bs='cs', k = 7)",
  s2 = "s(hMassGramsPVR, bs='cs', k = 7)",
  s3 = c(
    "s(S100, bs='cs', k = 7)",
    "s(S80, bs='cs', k = 7)",
    "s(S50, bs='cs', k = 7)",
    "s(S40, bs='cs', k = 7)",
    "s(S20, bs='cs', k = 7)",
    "s(S, bs='cs', k = 7)"
  ),
   bias = c("s(hAllZACitesLn, bs='cs',k = 7)", "s(hDiseaseZACitesLn, bs='cs', k=7)"),
  stringsAsFactors = FALSE)

terms = c(dummy_terms, terms)

all_viruses = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-table, cache=FALSE}
all_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```


Summary of top model:

```{r all-vir-summary, cache=FALSE}
summary(all_viruses$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r all-vir-contrib, cache=FALSE}
get_relative_contribs(all_viruses$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r all-vir-cv, cache=TRUE}
cv_gam(all_viruses$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# All Viruses GAM - Strict Associations

```{r all-vir-strict-fit, cache=TRUE}

model_family = poisson

all_viruses_strict = fit_all_gams(data_set,
                            outcome_variable = "TotVirusPerHost_strict",
                            poisson,
                            terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r all-vir-strict-table, cache=FALSE}
all_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r all-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(all_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r all-vir-strict-summary, cache=FALSE}
summary(all_viruses_strict$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r all-vir-strict-contrib, cache=FALSE}
get_relative_contribs(all_viruses_strict$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r all-vir-stict-cv, cache=TRUE}
cv_gam(all_viruses_strict$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# Viral Traits GAM - All Associations

```{r vtraits-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*(?<!stringent)$")]

model_family = binomial


data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)


terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic",
                       model_family = binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-table, cache=FALSE}
vtraits %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-summary, cache=FALSE}
summary(vtraits$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r vtraits-contrib, cache=FALSE}
get_relative_contribs(vtraits$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r vtraits-cv, cache=TRUE}
cv_gam(vtraits$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```


# Viral Traits GAM - Strict Associations


```{r vtraits-strict-fit, cache=TRUE}
PD_centers = names(viruses)[stri_detect_regex(names(viruses), "^(cb|st)_.*stringent$")]

data_set = viruses %>% 
  mutate_each_(funs("logp"), vars=PD_centers)
names(data_set)[names(data_set) %in% PD_centers] <- paste0(PD_centers, "Ln")
PD_centers <- paste0(PD_centers, "Ln")

dummys = as.data.frame(with(viruses, model.matrix(~vFamily))[,-1])
data_set = cbind(data_set, dummys)
dummy_terms = paste0("s(", names(dummys), ", bs = 're')")
names(dummy_terms) <- names(dummys)

model_family = binomial

#data_set = data_set %>% filter(NumHosts > 1)

terms = list(
  PD     = paste0("s(", PD_centers, ", bs='tp', k=7)"),
  bias   = c("s(vPubMedCitesLn, bs='tp', k=7)", "s(vWOKcitesLn, bs='tp', k=7)"),
  strand = c("s(RNA, bs='re')", "s(SS, bs='re')", "s(vCytoReplicTF, bs='re')"),
  vector = "s(Vector, bs='re')",
  env = "s(Envelope, bs='re')",
  genome = "s(vGenomeAveLengthLn, bs='tp', k=7)",
  stringsAsFactors=FALSE)

vtraits_strict = fit_all_gams(data_set,
                       outcome_variable = "IsZoonotic.stringent",
                       binomial,
                       terms)

```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r vtraits-strict-table, cache=FALSE}
vtraits_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r vtraits-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(vtraits_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r vtraits-strict-summary, cache=FALSE}
summary(vtraits_strict$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r vtraits-strict-contrib, cache=FALSE}
get_relative_contribs(vtraits_strict$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r vtraits-strict-cv, cache=TRUE}
cv_gam(vtraits_strict$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# Zoonoses in Domestic Animals GAM - All Associations

```{r dom-fit, cache=TRUE}

data_set = hosts %>% 
  filter(hMarOTerr == "Terrestrial",
         hWildDomFAO == "domestic") %>% 
   mutate(hHostNameFinal = as.factor(hHostNameFinal)) %>% 
   mutate(domestic_category = ifelse(is.na(domestic_category), "Other", domestic_category)) %>% 
  droplevels()

model_family = poisson

#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  phylo_distance = c("s(PdHoSa.cbCst, bs = 'tp', k = 7)", ""), #, "s(PdHoSaSTPD, bs = 're')"),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  offset = "offset(LnTotNumVirus)",
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_zoonoses = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-table, cache=FALSE}

domestic_zoonoses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-summary, cache=FALSE}
summary(domestic_zoonoses$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r dom-contrib, cache=FALSE}
get_relative_contribs(domestic_zoonoses$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r dom-cv, cache=TRUE}
cv_gam(domestic_zoonoses$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```


# Zoonoses in Domestic Animals GAM - Strict Associations

```{r dom-strict-fit, cache=TRUE}
model_family = poisson
domestic_zoonoses_strict = fit_all_gams(data_set,
                       outcome_variable = "NSharedWithHoSa_strict",
                       poisson,
                       terms)
```

Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-strict-table, cache=FALSE}
domestic_zoonoses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_zoonoses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-strict-summary, cache=FALSE}
summary(domestic_zoonoses_strict$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r dom-strict-contrib, cache=FALSE}
get_relative_contribs(domestic_zoonoses_strict$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r dom-strict-cv, cache=TRUE}
cv_gam(domestic_zoonoses_strict$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# All Viruses in Domestic Animals GAM - All Associations

```{r dom-vir-fit, cache=TRUE}
model_family = poisson
#  Create dummy variables for orders to use as random effects
dummys = as.data.frame(with(data_set, model.matrix(~hOrder))[,-1])
dummys2 = as.data.frame(with(data_set, model.matrix(~domestic_category))[,-1])
data_set = cbind(data_set, dummys, dummys2)
dummy_terms = as.list(paste0("s(", c(names(dummys), names(dummys2)), ", bs = 're')")) %>% 
  map(~ c(., ""))
names(dummy_terms) <- c(names(dummys), names(dummys2))

## Create data.frame of all possible models
terms = list(
  mass = c("s(hMassGramsPVR, bs = 'tp', k = 7)", ""),
  domestication = c("s(LnDOMYearBP, bs = 'tp', k = 7)",""),
  cont = c("s(hContinents, bs = 'tp', k = 7)", ""),
  category = c("s(domestic_category, bs = 're')", ""),
  bias = c("s(hAllZACitesLn, bs = 'tp', k = 7)", "s(hDiseaseZACitesLn, bs = 'tp', k = 7)", ""),
  stringsAsFactors=FALSE)

terms = c(dummy_terms, terms)

domestic_viruses = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-table, cache=FALSE}
model_family = poisson
domestic_viruses %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model` = terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-summary, cache=FALSE}
summary(domestic_viruses$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r dom-vir-contrib, cache=FALSE}
get_relative_contribs(domestic_viruses$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r dom-vir-cv, cache=TRUE}
cv_gam(domestic_viruses$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

# All Viruses in Domestic Animals GAM - Stringent Associations

```{r dom-vir-strict-fit, cache=TRUE}
model_family = poisson
domestic_viruses_strict = fit_all_gams(data_set,
                       outcome_variable = "TotVirusPerHost_strict",
                       poisson,
                       terms)
```


Terms in models with ΔAIC < 2.  All continuous terms effects are represented
as splines, all discrete terms as random effects:

```{r dom-vir-strict-table, cache=FALSE}
domestic_viruses_strict %>%
  filter(daic <= 2) %>%
  select(daic, terms) %>% 
    mutate(terms = stri_replace_all_regex(terms, "s\\(([^\\)]*)\\)", "$1")) %>%
  rename(ΔAIC = daic, `Terms in Model`=terms) %>% 
  kable()
```

Partial effect plots of all terms in top model:

```{r dom-vir-strict-plot, fig.width=10, fig.height=10, cache=FALSE}
plot(domestic_viruses_strict$model[[1]], all.terms=TRUE, pages=1, scale=0, residuals = TRUE)
```

Summary of top model:

```{r dom-vir-strict-summary, cache=FALSE}
summary(domestic_viruses_strict$model[[1]])
```

Relative fraction of deviance explained by each variable in the top model:

```{r dom-vir-strict-contrib, cache=FALSE}
get_relative_contribs(domestic_viruses_strict$model[[1]]) %>%
    mutate(rel_deviance_explained = paste0(signif(rel_deviance_explained*100, digits=3), "%")) %>% 
  rename(Term = term, `Relative Deviance Explained` = rel_deviance_explained) %>% 
  kable(align=c("l","r"))
```

10-fold cross-validation.  Good fit indicated by *non*-significant p-values:

```{r dom-vir-strict-cv, cache=TRUE}
cv_gam(domestic_viruses_strict$model[[1]]) %>%
    mutate(p_value = round(p_value, digits=3)) %>% 
  rename(Fold = fold, `Observations Fit`=n_fit, `Observations Held Out` = n_validate,
         `P-value`=p_value, `Mean Error` = mean_error) %>%
  kable(align=c("l","r", "r", "r", "r"))
```

<!-- # Publication plots -->

```{r export-for-plots, include=FALSE}
saveRDS(vtraits$model[[1]], P("model_fitting/viral_traits_model.rds"))
saveRDS(viruses, P("model_fitting/virus_data_processed.rds"))
saveRDS(all_viruses$model[[1]], P("model_fitting/all_viruses_model.rds"))
saveRDS(all_zoonoses$model[[1]], P("model_fitting/all_zoonoses_model.rds"))
saveRDS(list(all_zoonoses = all_zoonoses$model[[1]],
             all_zoonoses_strict = all_zoonoses_strict$model[[1]],
             all_viruses = all_viruses$model[[1]],
             all_viruses_strict = all_viruses_strict$model[[1]],
             vtraits = vtraits$model[[1]],
             vtraits_strict = vtraits_strict$model[[1]]),
        P("model_fitting/top_models.rds"))
```
